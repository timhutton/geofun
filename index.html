<!DOCTYPE html>
<html>
<head>
    <title>Geofun</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js" integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg==" crossorigin=""></script>


    <style>
        #map {
            width: 600px;
            height: 400px;
        }
    </style>

    <style>body { padding: 0; margin: 0; } html, body, #map { height: 100vh; width: 100vw; }</style>
</head>
<body>

<div id='map'></div>

<script>
var location_polling_interval_ms = 5000;
var players_string_polling_interval_ms = 5000;
var pulse_interval_ms = 3000;
var animation_interval_ms = 30;
var pulse_speed_m_per_s = 100;
var pulse_distance_m = 70;

var defaultLoc = L.latLng(52.185, 0.176); // a default view of Cambridge
var map = L.map('map').setView(defaultLoc,16);

L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
    maxZoom: 18,
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    id: 'mapbox.light'
    }).addTo(map);

var player = new Player( Math.random().toString(36).substring(7), defaultLoc );
var players = [];
var other_players_sprites = [];
var pulses = [];
var did_pan_once = false;

map.on('locationfound', onLocationFound);
map.on('locationerror', onLocationError);
requestLocation();
requestPlayersString();
setInterval( requestPlayersString, players_string_polling_interval_ms );
setInterval( animatePulses,        animation_interval_ms );
//setInterval( playerPulse,          pulse_interval_ms );

addCurrentPlayerSprites();

processPlayersString('0,klau,52.1855,0.1762\n0,foo,52.1851,0.1767\n0,bar,52.1859,0.1757\n'); // DEBUG

// ----------------------------------------------------------------------------

var sparkButton = L.Control.extend({
  options: {
    position: 'topleft'
  },
  onAdd: function (map) {
    var container = L.DomUtil.create('input','my-button btn');
    container.type="button";
    container.title="\u26A1";
    container.value = "\u26A1";
    container.label = "\u26A1";

    container.style.backgroundColor = 'white';
    container.style.width = '30px';
    container.style.height = '30px';
    container.onclick = function(){
        playerPulse();
    }
    return container;
  },
});

map.addControl(new sparkButton());

var presentButton = L.Control.extend({
  options: {
    position: 'topleft'
  },
  onAdd: function (map) {
    var container = L.DomUtil.create('input','my-button btn');
    container.type="button";
    container.title="\uD83C\uDF81";
    container.value = "\uD83C\uDF81";
    container.label = "\uD83C\uDF81";

    container.style.backgroundColor = 'white';
    container.style.width = '30px';
    container.style.height = '30px';
    container.onclick = function(){
        playerPulse();
    }
    return container;
  },
});

map.addControl(new presentButton());

function Player(id, loc) {
    this.id = id;
    this.loc = loc;
}

function Pulse(loc,start_time_ms) {
    this.loc = loc;
    this.state = 0;
    this.start_time_ms = start_time_ms;
}

function onLocationFound(e) {
    player.loc.lat = e.latlng.lat;
    player.loc.lng = e.latlng.lng;
    updateAllPlayersSprites();
    if(!did_pan_once) { did_pan_once = true; map.panTo(player.loc); }
    setTimeout(requestLocation,location_polling_interval_ms); // (only request again when succeeded)
    sendLocation(e.latlng);
}

function onLocationError(e) {
    alert(e.message);
}

function sendLocation(latlng) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "http://api.geofun.org.uk:8080/insert", true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.send("user="+player.id+"&latitude="+player.loc.lat.toFixed(6)+"&longitude="+player.loc.lng.toFixed(6));
}

function requestLocation() {
    map.locate({ enableHighAccuracy:true });
}

function requestPlayersString() {
    var HttpClient = function() {
        this.get = function(url, callback) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200)
                    callback(xhr.responseText);
            }
            xhr.open( "GET", url, true );
            xhr.send( null );
        }
    }
    var client = new HttpClient();
    client.get('http://api.geofun.org.uk:8080/data', processPlayersString);
}

function processPlayersString(response) {
    parsePlayersString(response);
    updateOtherPlayersSprites();
}

function parsePlayersString(response) {
    players = [];
    var lines = response.split('\n');
    for(var i=0;i<lines.length-1;i++) {
        var parts = lines[i].split(',');
        players[i] = new Player( parts[1], L.latLng(parseFloat(parts[2]),parseFloat(parts[3])) );
    }
}

function updateAllPlayersSprites() {
    updateCurrentPlayerSprites();
    updateOtherPlayersSprites();
}

function updateOtherPlayersSprites() {
    removeOtherPlayersSprites();
    addOtherPlayersSprites();
}

function removeOtherPlayersSprites() {
    for(var i=0;i<other_players_sprites.length;i++) {
        map.removeLayer(other_players_sprites[i])
    }
    other_players_sprites = [];
}

function addOtherPlayersSprites() {
    for(var i=0;i<players.length;i++) {
        if(players[i].id !== player.id ) {
            var marker = L.marker(players[i].loc);
            marker.addTo(map);
            marker.bindPopup(getOtherPlayerPopupText(players[i]));
            other_players_sprites.push(marker);
            var circle = L.circle(players[i].loc,20);
            circle.addTo(map);
            other_players_sprites.push(circle);
        }
    }
}

function getDistanceAsString(m) {
    if(m >= 1000) {
        var km = m/1000;
        return km.toFixed(0)+"km";
    }
    else {
        return m.toFixed(0)+"m";
    }
}

function getOtherPlayerPopupText(p) {
    var link = 'https://www.google.com/maps/dir//'+p.loc.lat.toFixed(6)+','+p.loc.lng.toFixed(6);
    var dist = getDistanceAsString(p.loc.distanceTo(player.loc));
    return p.id+' <a href="'+link+'">'+dist+'</a>';
}

function addCurrentPlayerSprites() {
    var greenIcon = new L.Icon({
      iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
    current_player_marker = L.marker(player.loc,{icon: greenIcon});
    current_player_marker.addTo(map);
    current_player_marker.bindPopup(player.id+" (you)");
    current_player_circle = L.circle(player.loc,30);
    current_player_circle.addTo(map);
}

function updateCurrentPlayerSprites() {
    current_player_marker.update();
    current_player_circle.redraw();
}

function playerPulse() {
    removePulses();
    var time_now_ms = new Date().getTime();
    pulses.push(new Pulse( player.loc, time_now_ms ));
    var have_pulsed = [];
    have_pulsed[player.id] = true;
    // trigger a chain reaction of pulses by proximity
    var added_new = true;
    while(added_new) {
        added_new = false;
        for(var iPulse=0;iPulse<pulses.length;iPulse++) {
            var pulse = pulses[iPulse];
            // does this pulse trigger any player?
            for(var i=0;i<players.length;i++) {
                // does the pulse trigger this player?
                var candidateID = players[i].id;
                var m = players[i].loc.distanceTo(pulse.loc);
                if(!have_pulsed[candidateID] && m < pulse_distance_m ) {
                    var delay_ms = 1000 * ( m / pulse_speed_m_per_s );
                    pulses.push(new Pulse( players[i].loc, pulse.start_time_ms+delay_ms ));
                    have_pulsed[candidateID] = true;
                    added_new = true;
                }
            }
        }
    }
}

function animatePulses() {
    for(var i=pulses.length-1;i>=0;i--) {
        var remove = animatePulse(pulses[i]);
        if( remove ) {
            pulses.splice(i,1);
        }
    }
}

function animatePulse(pulse) {
    var remove = false;
    var time_now_ms = new Date().getTime();
    if(pulse.state == 0) {
        if(time_now_ms>pulse.start_time_ms) {
            pulse.circle = L.circle(pulse.loc, 5);
            pulse.circle.addTo(map);
            pulse.state = 1;
        }
    }
    else {
        if(pulse.circle.getRadius() > pulse_distance_m) {
            map.removeLayer(pulse.circle);
            remove = true;
        }
        else {
            var elapsed_time_s = ( time_now_ms - pulse.start_time_ms ) / 1000;
            var new_radius = 5 + elapsed_time_s * pulse_speed_m_per_s;
            var new_opacity = 1 - new_radius / pulse_distance_m;
            var new_fill_opacity = 0.4 * new_opacity;
            pulse.circle.setRadius(new_radius);
            pulse.circle.setStyle({opacity: new_opacity, fillOpacity: new_fill_opacity});
            pulse.circle.redraw();
        }
    }
    return remove;
}

function removePulses() {
    for(var i=0;i<pulses.length;++i) {
        if( pulses[i].circle !== undefined ) {
            map.removeLayer(pulses[i].circle);
        }
    }
    pulses=[];
}

</script>

</body>
</html>
