<!DOCTYPE html>
<html>
<head>
    <title>Geofun</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js" integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg==" crossorigin=""></script>


    <style>
        #map {
            width: 600px;
            height: 400px;
        }
    </style>

    <style>body { padding: 0; margin: 0; } html, body, #map { height: 100vh; width: 100vw; }</style>
</head>
<body>

<div id='map'></div>

<script>
    function onLocationFound(e) {
        sendLocation(e.latlng);
    }

    function onLocationError(e) {
        alert(e);
    }

    function requestLocation() {
        map.locate();
    }

    function requestUsers() {
        var HttpClient = function() {
            this.get = function(url, callback) {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200)
                        callback(xhr.responseText);
                }
                xhr.open( "GET", url, true );
                xhr.send( null );
            }
        }
        var client = new HttpClient();
        client.get('https://geofun.org.uk:8081/', function(response) {
                for(var i=0;i<current_layers.length;i++) {
                    map.removeLayer(current_layers[i])
                }
                current_markers = [];
                var lines = response.split('\n');
                users = [];
                for(var i=0;i<lines.length-1;i++) {
                    var parts = lines[i].split(',');
                    users[i] = { id: parts[1], latlng: L.latLng(parseFloat(parts[2]),parseFloat(parts[3])) };
                    var marker = L.marker(users[i].latlng);
                    marker.addTo(map);
                    marker.bindPopup(lines[i]);
                    current_layers.push(marker);
                    var circle = L.circle(users[i].latlng,20);
                    circle.addTo(map);
                    current_layers.push(circle);
                }
            });
    }

    function sendLocation(latlng) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "https://geofun.org.uk/insert", true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.send("user="+userID+"&latitude="+latlng.lat.toFixed(6)+"&longitude="+latlng.lng.toFixed(6));
    }

    // -------------------------------------------------------------------------

    var map = L.map('map').fitWorld();

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
            '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.streets'
        }).addTo(map);

    var userID = Math.random().toString(36).substring(7);
    var users = [];
    var current_layers = [];
    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);
    map.setView(L.latLng(52.185, 0.176),16); // a default view of Cambridge
    requestUsers();
    requestLocation();
    setInterval(requestLocation,5000);
    setInterval(requestUsers,5000);

</script>

</body>
</html>
